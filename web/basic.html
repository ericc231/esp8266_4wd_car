<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <style>
        body {
            overflow: hidden;
            padding: 0;
            margin: 0;
            background-color: #BBB;
        }

        #info {
            position: absolute;
            top: 0px;
            width: 100%;
            padding: 5px;
            text-align: center;
        }

        #info a {
            color: #66F;
            text-decoration: none;
        }

        #info a:hover {
            text-decoration: underline;
        }

        #container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            padding: 0;
            margin: 0;
            -webkit-user-select: none;
            -moz-user-select: none;
        }
    </style>
</head>
<body>
<div id="container"></div>
<div id="info">
    <a href="http://learningthreejs.com/blog/2011/12/26/let-s-make-a-3d-game-virtual-joystick/" target="_blank">VirtualJoystick.js</a>
    A library javascript to provide a virtual joystick on touchscreen.
    -
    inspired by this
    <a href="http://sebleedelisle.com/2011/04/multi-touch-game-controller-in-javascripthtml5-for-ipad/">post</a>
    from
    <a href="http://sebleedelisle.com/">seb.ly</a>
    <br/>
    Touch the screen and move
    -
    works with mouse too as debug
    <br/>
    <span id="result"></span>
</div>
<script src="js/virtualjoystick.js"></script>
<script>
    //        var addr = location.hostname;
    var addr = '192.168.2.37';

    var connection = new WebSocket('ws://' + addr + ':81/', ['arduino']);
    connection.onopen = function () {
        connection.send('Connect ' + new Date());
    };
    connection.onerror = function (error) {
        console.log('WebSocket Error ', error);
    };
    connection.onmessage = function (e) {
        console.log('Server: ', e.data);
    };

    function send(cmd) {
        connection.send(cmd);
    }

    function buildCmd(coord) {
        var l = getDirAndSpeed(coord.x);
        var r = getDirAndSpeed(coord.y);
        return '#' + l.d + l.s + r.d + r.s;
    }

    function getDirAndSpeed(c) {
        var d;
        if (c >= 0) {
            d = 'f';
        } else {
            d = 'b';
            c = -c;
        }
        if (c < 100) {
            c = 0;
        }
        var s = pad(c);
        return {d: d, s: s};
    }

    function pad(num) {
        var s = "00" + num;
        return s.substr(s.length - 3);
    }

    console.log("touchscreen is", VirtualJoystick.touchScreenAvailable() ? "available" : "not available");

    var sc45 = sinDegrees(45);

    console.log(sc45);

    var joystick = new VirtualJoystick({
        container: document.getElementById('container'),
        mouseSupport: true,
        limitStickTravel: true,
        stickRadius: 100

    });
    joystick.addEventListener('touchStart', function () {
        console.log('down')
    })
    joystick.addEventListener('touchEnd', function () {
        console.log('up')
    })

    setInterval(function () {
        var coord = calc();
        var cmd = buildCmd(coord);
        var outputEl = document.getElementById('result');
        outputEl.innerHTML = '<b>Result:</b> '
                + ' x:' + coord.x
                + ' y:' + coord.y
                + '<br/>'
                + 'cmd: ' + cmd
                + '<br/>'
                + ' dx:' + joystick.deltaX()
                + ' dy:' + joystick.deltaY()
                + (joystick.right() ? ' right' : '')
                + (joystick.up() ? ' up' : '')
                + (joystick.left() ? ' left' : '')
                + (joystick.down() ? ' down' : '');
        send(cmd);
    }, 1 / 5 * 1000);

    function calc() {
        var x = joystick.deltaX();
        var y = -joystick.deltaY();
        var x1 = sc45 * (x + y);
        var y1 = sc45 * (-x + y);
        x1 = Math.round(x1 * 255 / 100);
        y1 = Math.round(y1 * 255 / 100);
        return {x: x1, y: y1};
    }

    function sinDegrees(angle) {
        return Math.sin(angle / 180 * Math.PI);
    }

</script>
</body>
</html>