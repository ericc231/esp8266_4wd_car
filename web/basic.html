<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <style>
        body {
            overflow: hidden;
            padding: 0;
            margin: 0;
            background-color: #BBB;
        }

        #info {
            position: absolute;
            top: 0px;
            width: 100%;
            padding: 5px;
            text-align: center;
        }

        #info a {
            color: #66F;
            text-decoration: none;
        }

        #info a:hover {
            text-decoration: underline;
        }

        #container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            padding: 0;
            margin: 0;
            -webkit-user-select: none;
            -moz-user-select: none;
        }
    </style>
</head>
<body>
<div id="container"></div>
<div id="info">
    Uptime: <span id="uptime"></span>
    <br/>
    A: <span id="amp"></span>
    <br/>
    V: <span id="volt"></span>
    <br/>
    <span id="result"></span>
</div>
<script src="js/virtualjoystick.js"></script>
<script>
    //        var addr = location.hostname;
    var addr = '192.168.2.37';

    var connection = new WebSocket('ws://' + addr + ':81/', ['arduino']);
    connection.binaryType = "arraybuffer";
    connection.onopen = function () {
        //connection.send('Connect ' + new Date());
    };
    connection.onerror = function (error) {
        console.log('WebSocket Error ', error);
    };
    connection.onmessage = function (e) {
//        console.log('Server: ', e.data);
        var bytearray = new Uint8Array(event.data);
        if (bytearray[0] == 0x0A && bytearray.length == 8) {

            var uptime = (bytearray[1] << 16) | (bytearray[2] << 8) | bytearray[3];
            var outputEl = document.getElementById('uptime');
            outputEl.innerHTML = uptime;

            var amp = (bytearray[4] << 8) | bytearray[5];
            outputEl = document.getElementById('amp');
            outputEl.innerHTML = amp;

            var volt = (bytearray[6] << 8) | bytearray[7];
            outputEl = document.getElementById('volt');
            outputEl.innerHTML = volt;
        }
    };

    function send(cmd) {
//        connection.send(cmd);
        connection.send(cmd.buffer);
    }

    var sc45 = sinDegrees(45);
    console.log(sc45);
    var R1 = 100;
    var R2 = R1 * sc45;

    function buildCmd(coord) {
        var x = coord.x;
        var y = coord.y;
        if (y > R2 && Math.abs(x) <= y) {
            x = R2 * x / y;
            y = R2;
        } else if (x > R2 && Math.abs(y) <= x) {
            y = R2 * y / x;
            x = R2;
        } else if (y < -R2 && Math.abs(x) <= -y) {
            x = -R2 * x / y;
            y = -R2;
        } else if (x < -R2 && Math.abs(y) <= -x) {
            y = -R2 * y / x;
            x = -R2;
        }

        x = x * 255 / R2;
        y = y * 255 / R2;

        //var l = getDirAndSpeed(Math.round(x));
        //var r = getDirAndSpeed(Math.round(y));
        //return '#' + l.d + l.s + r.d + r.s;

        var bytearray = new Uint8Array(5);
        bytearray[0] = 0x0C;
        bytearray[1] = getDir(x);
        bytearray[2] = getSpeed(x);
        bytearray[3] = getDir(y);
        bytearray[4] = getSpeed(y);

        return bytearray;
    }

    function getDir(c) {
        return c >= 0 ? 1 : 2;
    }

    function getSpeed(c) {
        if (c < 0) {
            c = -c;
        }
        return c;
    }

    function getDirAndSpeed(c) {
        var d;
        if (c >= 0) {
            d = 'f';
        } else {
            d = 'b';
            c = -c;
        }
        if (c < 100) {
//            c = 0;
        }
        var s = pad(c);
        return {d: d, s: s};
    }

    function pad(num) {
        var s = "00" + num;
        return s.substr(s.length - 3);
    }

    console.log("touchscreen is", VirtualJoystick.touchScreenAvailable() ? "available" : "not available");


    var joystick = new VirtualJoystick({
        container: document.getElementById('container'),
        mouseSupport: true,
        limitStickTravel: true,
        stickRadius: 100

    });
    joystick.addEventListener('touchStart', function () {
        console.log('down')
    })
    joystick.addEventListener('touchEnd', function () {
        console.log('up')
    })

    setInterval(function () {
        var coord = calc();
        var cmd = buildCmd(coord);
        var outputEl = document.getElementById('result');
        outputEl.innerHTML = '<b>Result:</b> '
                + ' x:' + coord.x
                + ' y:' + coord.y
                + '<br/>'
                + 'cmd: ' + cmd
                + '<br/>'
                + ' dx:' + joystick.deltaX()
                + ' dy:' + joystick.deltaY()
                + (joystick.right() ? ' right' : '')
                + (joystick.up() ? ' up' : '')
                + (joystick.left() ? ' left' : '')
                + (joystick.down() ? ' down' : '');
        send(cmd);
    }, 1 / 20 * 1000);

    function calc() {
        var x = joystick.deltaX();
        var y = -joystick.deltaY();
        var x1 = sc45 * (x + y);
        var y1 = sc45 * (-x + y);
        return {x: x1, y: y1};
    }

    function sinDegrees(angle) {
        return Math.sin(angle / 180 * Math.PI);
    }

</script>
</body>
</html>